### 后台任务概述

#### 功能介绍

为了降低设备耗电速度、保障用户使用流畅度，系统会对退至后台的应用进行管控。包括进程挂起（即系统不再为应用进程分配CPU资源，同时对应的公共事件等不再发给应用进程）和进程终止。

+ 应用退至后台一小段时间（由系统定义），应用进程会被挂起
+ 应用退至后台，在后台被访问一小段时间（由系统定义），应用进程会被挂起
+ 资源不足时，系统会终止部分应用进程（即回收该进程的所有资源）。

同时，为了保障后台音乐播放、日历提醒等功能的正常使用，系统提供了规范内受约束的后台任务，扩展应用在后台运行时间。



#### 资源使用约束

对于运行的进程，系统会给予一定的资源配额约束，包括进程在连续一段时间内内存的使用、CPU使用占比，以及24小时磁盘写的IO量，均有对应的配额上限。超过配额上限时，如果进程处于前台，系统有对应的warning日志，如果进程处于后台，系统会终止该进程。





+ 短时任务
+ 尝试任务
+ 延迟任务
+ 代理提醒：应用退后台或进程终止后，系统会代理应用做相应的提醒。适当用于定时提醒类业务，当前支持的提醒类型包括倒计时、日历和闹钟三类。



### 短时任务

**申请时机**：应用需要在前台或退至后台5秒内，申请短时任务，否则会申请失败。

**数量限制**：一个应用同一时刻最多申请3个短时任务。

**配额机制**：一个应用会有一定的短时任务配额，单日配额默认为10分钟，单词配额最大为为3分钟，低电量时单词配额默认为1分钟，配额消耗完不允许在申请短时任务。

**配额计算**：仅当应用在后台，对应用下的短时任务计时；同一个应用下的同一个时间段的短时任务，不重复计时。

**超时**：短时任务即将超时时，系统会回调应用，应用需要取消短时任务。如果超时不取消，系统会终止对应的应用进程。





### 长时任务

| 参数名                  | 描述       | 配置项                | 场景举例                             |
| ----------------------- | ---------- | --------------------- | ------------------------------------ |
| DATA_TRANSFER           | 数据传输   | dataTransfer          | 后台下载大文件，如浏览器后台下载等。 |
| AUDIO_PLAYBACK          | 音频播放   | audioPlayback         | 音乐类应用在后台播放音乐。           |
| AUDIO_RECORDING         | 录音       | audioRecording        | 录音机在后台录音。                   |
| LOCATION                | 定位导航   | location              | 导航类应用后台导航。                 |
| BLUETOOTH_INTERACTION   | 蓝牙相关   | bluetoothInteraction  | 通过蓝牙传输分享的文件。             |
| MULTI_DEVICE_CONNECTION | 多设备互联 | multiDeviceConnection | 分布式业务连接。                     |

+ **申请限制**：长时任务仅支持UIAbility申请
+ **数量限制**：一个UIAbility同一时刻仅支持申请一个尝试任务，即在一个长时任务结束后才可能继续申请。如果一个应用同时需要申请多个尝试任务，需要创建多个UIAbility；**一个应用的一个UIAbility申请尝试任务后，整个应用下的所有进程均不会被挂起**。
+ **运行限制**：系统会进行长时任务校验。若应用申请了长时任务，但未真正执行申请类型的长时任务或申请类型的任务已结束，系统会对应用进行管控。例如系统检测到应用申请了AUDIO_PLAYBACK（音频播放）。但实际未播放音乐，系统则会终止对应的进程。



### 延迟任务

应用推迟后台后，需要执行实时性要求不高的任务，例如有网络时不定期主动获取邮件等，可以使用延迟任务。当应用满足设定条件（包括网络类型、充电类型、存储状态、电池状态、定时状态等）时，将任务添加到执行队列，系统会根据内存、功耗、设备温度、用户使用习惯等统一调度拉起应用。



+ **数量限制**：一个应用同一时刻最多申请10个延迟任务。

+ **执行频率限制**：系统会根据应用的活跃分组，对延迟任务做分级管控，限制延迟任务调度的执行频率。

  | 应用活跃分组     | 延迟任务执行频率 |
  | ---------------- | ---------------- |
  | 活跃分组         | 最小间隔2小时    |
  | 经常使用分组     | 最小间隔4小时    |
  | 常用使用         | 最小间隔24小时   |
  | 极少使用分组     | 最小间隔48小时   |
  | 受限使用分组     | 禁止             |
  | 从未使用分组     | 禁止             |
  | 能效资源豁免分组 | 不受限制         |

+ **超时**：WorkScheduleExtensionAbility单次回调最长运行2分钟。如果超时不取消，系统会终止对应的Extension进程。

+ **调度延迟**：系统会根据内存、功耗、设备温度、用户使用习惯等统一调度，如当系统内存资源不足或温度达到一定档位时，系统将延迟调度该任务。



### 代理提醒

#### 功能介绍

+ 应用退到后台或进程终止后，仍然有一些提醒用户的定时类任务，例如购物类应用抢购提醒等，为满足此类功能场景，系统提供了代理提醒（reminderAgentManager）的能力。当应用退至后台或进程终止后，系统会代理应用做相应的提醒。当前支持的提醒类包括：倒计时、日历和闹钟。
+ 倒计时类：基于倒计时的提醒功能。
+ 日历类：基于日历的提醒功能。
+ 闹钟类：基于时钟的提醒功能。

#### 约束与限制

+ 个数限制：一个三方应用支持最多30个有效提醒（有效即发布成功），一个系统应用支持最多12000个有效提醒。
+ 跳转限制：点击提醒通知后跳转的应用必须是申请代理提醒的本应用。



