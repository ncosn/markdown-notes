### 通知概述

#### 通知流程

通知业务流程由**通知子系统**、**通知发送端**、**通知订阅端**组成。

一条通知从通知发送端产生，通过IPC通信发送到通知子系统，再由通知子系统分发给通知订阅端、

系统应用还支持通知相关配置，如使能开关、配置参数由系统配置发起请求，发送到通知子系统存储到内存和数据库。



### 使能通知

#### 请求使能通知

开发者可以在通知发布前调用requestEnableNotification()方法，弹窗让用户选择是否开启使能开关，仅弹窗一次，后续调用该接口不再弹窗。此方法对调用方做用户授权。

```ts
notificationManager.requestEnableNotification()
	.then( ()=> {
    	console.info(TAG, `requestEnableNotification success`);
    	this.getPixelMap();
	})
	.catch((err) => {
    console.info(TAG, `requestEnableNotification fail, err: ${JSON.stringify(err)}`);
})
```



#### 设置使能通知

开发者如果需要管理第三方应用的通知使能，有两种方案：

+ 调用setNotificationEnable(bundle: BundleOption, enable: boolean)方法，设置目标应用是否能发送通知，**目前只用于通知管理**；需要权限ohos.permission.NOTIFICATION_CONTROLLER（仅系统应用）
+ 下拉通知栏，点击通知设置进去通知批量管理页面，点击目标应用进去通知管理页面，点击“允许通知”按钮开启/关闭通知（推荐使用）





### 发送通知

#### 通知类型

+ 基础文本类型
+ 长文本类型
+ 多行文本类型
+ 图片类型



#### 步骤

1、定义发送通知的notificationRequest；

```ts
let notificationRequest: notificationManager.NotificationRequest = {
    content: {
        contentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
        normal: {
          title: 'basic title',
          text: 'basic text'
        }
      }
    }
```

2、调用notificationManager.publish(notificationRequest)方法发布通知

```ts
notificationManager.publish(notificationRequest)
      .then(()=>{
        console.info(TAG, 'publish basic success')
      })
      .catch((err)=> {
        console.error(TAG, `publish basic fail, err: ${JSON.stringify(err)}`)
      })
```

> 注意：
>
> 1. 未指定id、发布的通知id一样时，后发布的通知会覆盖先发布的通知；
> 2. 普通文本类型通知由标题（title）、文本内容（text）、和附加信息三个字段组成，其中标题和文本内容是必填字段，大小均需要小于200字节；
> 3. 长文本继承了普通文本类型的字段，同时新增了长文本内容、内容概要和通知展开时的标题，**其中长文本内容不超过1024字节**，其他字段小于200字节
> 4. 多行文本
> 5. 图片类型通知继承了普通文本类型的字段，同时新增了图片内容、内容概要和通知展开时的标题，图片内容为PixelMap类型对象，**其大小不能超过2M**（PixelMap的大小，不是原图大小）



通知图片中获取图片的方法：

```ts
async getPixelMap() {
    try {
        let buff: Uint8Array = getContext(this).resourceManager.getRawFileContentSync('test.png')
        let imageSource: image.ImageSource = image.createImageSource(buff.buffer);
        pixelMap = await imageSource.createPixelMap();
    } catch (error) {
        console.error(TAG, `getPixelMap fail, err: ${JSON.stringify(error)}`);
    }
}
```



### 通知行为

#### 行为意图

WantAgent提供了封装行为意图的能力，该行为意图是指拉起指定的应用组件及发布公共事件等能力。





#### 行为通知实现

发布通知的应用向应用组件管理服务AMS（Ability Manager Service）申请WantAgent，然后随其他通知信息一起发送给桌面，当用户在桌面通知栏上点击通知时，触发WantAgent动作。



#### 发送行为通知

1. 创建发布公共事件的WantAgent的WantAgentInfo信息

   ```ts
   let wantAgentInfo: wantAgent.WantAgentInfo = {
       wants: [
           {
               bundleName: 'com.ohos.settings',
               abilityName: 'com.ohos.settings.MainAbility'
           }
       ],
       requestCode: 0,
       operationType: wantAgent.OperationType.START_ABILITY
   };
   ```

2. 将wantAgentInfo作为参数，调用getWantAgent()方法进行获取WantAgent

   ```ts
   let wantAgentObj: WantAgent;
   
   wantAgent.getWantAgent(wantAgentInfo)
     .then((want) => {
       console.info(TAG, 'getWantAgent success');
       wantObj = want;
     })
     .catch((err) => {
       console.error(TAG, `getWantAgent fail, err: ${JSON.stringify(err)}`)
     })
   ```

3. 构造NotificationRequest对象，并发布WantAgent通知

   ```ts
   let notificationRequest: notificationManager.NotificationRequest = {
         id: 5,
         content: {
           contentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
           normal: {
             title: 'want title',
             text: 'want text'
           }
         },
         wantAgent: wantObj
       }
       notificationManager.publish(notificationRequest)
         .then(() => {
           console.info(TAG, `publish want success`);
         })
         .catch((err) => {
           console.error(TAG, `publish want fail, err: ${JSON.stringify(err)}`)
         })
   ```

   
